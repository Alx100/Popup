/*
 * TF Popup
 * v0.9.1
 
Copyright (C) 2011  Todd Francis

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

*/
(function(b){b.TFPopup=function(m,h){var p={modal:!1,popupWidth:null,popupHeight:null,backgroundOpacity:0.7,loader:{content:"",ID:"tf_loader"},content:"",callback:{onOpen:null,onClose:null,onError:null,onSuccess:null,onSubmit:null},closeButton:{content:"Close",hidden:!1,ID:"tf_close_button"},hideFlash:!1,useMarkup:!1,markup:{top:'<div class="popup">',bottom:"</div>",inputRowClass:"form_row",invalidRowClass:"invalid_row",errorClass:"error",popupID:"tf_popup_cont",backgroundID:"tf_popup_background"},
ajaxContent:!0,ajaxSubmit:!0},a=this;a.version="0.9.1";a.settings={};var g,c,k,e;a.init=function(){a.settings=b.extend(!0,{},p,h)};a.open=function(){g=b('<div id="'+a.settings.markup.backgroundID+'" />').appendTo(b(document.body)).css({opacity:a.settings.backgroundOpacity});c=b('<div id="'+a.settings.markup.popupID+'" />').appendTo(b(document.body));g.click(function(b){b.preventDefault();a.settings.modal||a.close()});b(window).resize(function(){a.center()});a.settings.hideFlash&&b("object, embed").css("visibility",
"hidden");g.fadeIn("fast");c.css({display:"block",opacity:0}).animate({opacity:1},"fast");k=b('<div id="'+a.settings.loader.ID+'">'+a.settings.loader.content+"</div>");c.html(k);a.center();a.settings.content?a.loadContent(a.settings.content):(l("No content to load"),a.close())};a.close=function(){a.settings.hideFlash&&b("object, embed").css("visibility","visible");g.fadeOut("fast",function(){g.remove();c.remove();a.settings.callback.onClose&&a.settings.callback.onClose(a)});c.fadeOut("fast");e&&e.length>
0&&e.fadeOut("fast",function(){e.remove()})};a.center=function(){var b=a.settings.popupWidth?parseInt(a.settings.popupWidth,10):c.children().outerWidth(),e=a.settings.popupHeight?parseInt(a.settings.popupHeight,10):c.children().outerHeight(),f=document.documentElement.clientHeight;c.css({top:f*0.5-e*0.5,left:document.documentElement.clientWidth*0.5-b*0.5});g.css({height:f})};a.loadContent=function(i,e){var f;if(a.settings.ajaxContent&&e!==!0){f=i;var d=a.$element.attr("data-tf_append");d&&(f+=i.indexOf("?")>
-1?"&"+d:"?"+d);b.get(f,function(b,f,d){f=="error"?c.html("<p>Content could not be loaded: "+d.statusText+"</p>"):c.html(b);n();a.center();a.settings.callback.onOpen&&a.settings.callback.onOpen(a);o()})}else f=typeof i=="function"?i(a):i,typeof f=="string"?c.html(f):typeof f=="object"?c.html(f.html()):l("Could not parse content of type "+typeof f),n(),a.center(),o(),a.settings.callback.onOpen&&a.settings.callback.onOpen(a)};var n=function(){a.settings.useMarkup&&c.wrapInner(a.settings.markup.top+
a.settings.markup.bottom);e=b('<a id="'+a.settings.closeButton.ID+'" href="#">'+a.settings.closeButton.content+"</a>");a.settings.closeButton.hidden||e.appendTo(c);e.click(function(){a.close();return!1});e.fadeIn("fast")},j=function(b,c){if(a.settings.callback[b])return a.settings.callback[b][c]?a.settings.callback[b][c](a):a.settings.callback[b](a)},o=function(){c.find("form").each(function(c,e){b(e).submit(function(c){var d=b(this);j("onSubmit",d.attr("id"))!==!1?a.settings.ajaxSubmit?(c.preventDefault(),
(c=d.attr("action"))?b.post(c,d.serialize(),function(c){d.find("."+a.settings.markup.inputRowClass).removeClass(a.settings.markup.invalidRowClass);d.find("."+a.settings.markup.errorClass).remove();k.remove();c.status=="error"?(c.errors&&b.each(c.errors,function(){d.find("#"+this).parents("."+a.settings.markup.inputRowClass).addClass(a.settings.markup.invalidRowClass)}),d.prepend(c.feedback),j("onError",d.attr("id"))):(j("onSuccess",d.attr("id")),c.feedback&&d.before(c.feedback).remove());a.center()},
"json"):l("No validation URL supplied")):j("onSuccess",d.attr("id")):(c.preventDefault(),j("onError",d.attr("id")))})})};a.init();var l=function(a){window.console&&window.console.log&&console.log(a)}};b.fn.TFPopup=function(m){return this.each(function(){if(void 0==b(this).data("TFPopup")){var h=new b.TFPopup(this,m);b(this).data("TFPopup",h);h.$element=b(this);b(this).click(function(b){b.preventDefault();h.open()})}})}})(jQuery);